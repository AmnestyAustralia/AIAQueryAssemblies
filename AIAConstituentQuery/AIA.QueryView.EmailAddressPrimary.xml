<QueryViewSpec
  xmlns="bb_appfx_queryview"
  xmlns:c="bb_appfx_commontypes" 
  ID="61098a26-d96b-47a1-9998-a82a484a03d7"
  Name="Email Address (Primary) (AIA)"
  Description="This provides the ability to query for primary email address information."
  Author="Danny Smith (AIA)"
  IsRoot="false"
  PrimaryKeyField="ID"
  RecordType="Email"
  c:SecurityUIFolder="Constituent\Email"
  >
  <Extensibility>
    <Tables>
      <Table Name="EMAILADDRESS" />
    </Tables>
  </Extensibility>
  <ResourceFile AssemblyName="Blackbaud.AppFx.Constituent.Catalog.dll" ClassName="Blackbaud.AppFx.Constituent.Catalog.EmailAddress.Query" />

  <!-- define the view used to return data for the query -->
  <ViewImplementation ViewName="USR_AIA_V_QUERY_CONSTITUENTPRIMARYEMAILADDRESS">
    <ViewSQL>
      <![CDATA[
      
        select
          EMAILADDRESS.ID,

          EMAILADDRESS.CONSTITUENTID,
          EMAILADDRESSTYPECODE.DESCRIPTION as [EMAILADDRESSTYPECODEID_TRANSLATION],
          EMAILADDRESS.EMAILADDRESS,
          --EMAILADDRESS.ISPRIMARY,
          [ADDEDBY].APPLICATIONNAME as [ADDEDBY_APPLICATION],
          [ADDEDBY].USERNAME as [ADDEDBY_USERNAME],
          [CHANGEDBY].APPLICATIONNAME as [CHANGEDBY_APPLICATION],
          [CHANGEDBY].USERNAME as [CHANGEDBY_USERNAME],
          EMAILADDRESS.DATEADDED,
          EMAILADDRESS.DATECHANGED,
          EMAILADDRESS.TSLONG,
          EMAILADDRESS.DONOTEMAIL,
          INFOSOURCECODE.DESCRIPTION as [INFOSOURCECODEID_TRANSLATION],
          EMAILADDRESS.INFOSOURCECOMMENTS,
          EMAILADDRESS.RELATIONSHIPID,
          EMAILADDRESS.ORIGIN,
          case 
            when [ORIGINCODE] <> 0 then 
              dbo.UFN_EMAILADDRESS_ORIGINCODE_GETDESCRIPTION([ORIGINCODE]) 
            else INFOSOURCECODE.DESCRIPTION 
          end as [ORIGININFO],
          EMAILADDRESS.STARTDATE,
          EMAILADDRESS.ENDDATE,
          case when EXISTS(SELECT ID FROM dbo.EMAILINVALIDRECIPIENT WHERE EMAILINVALIDRECIPIENT.ADDRESS = EMAILADDRESS.EMAILADDRESS AND EMAILINVALIDRECIPIENT.ISBLACKLISTED = 1 and CATEGORY <> 112) then 1 else 0 end as BOUNCED,
          [EMAILADDRESS].[EMAILADDRESSTYPECODEID],
          [EMAILADDRESS].[INFOSOURCECODEID],
          case when EXISTS(SELECT ID FROM dbo.EMAILINVALIDRECIPIENT WHERE EMAILINVALIDRECIPIENT.ADDRESS = EMAILADDRESS.EMAILADDRESS AND EMAILINVALIDRECIPIENT.ISBLACKLISTED = 1 and CATEGORY = 112) then 1 else 0 end as SPAMCOMPLAINT
          /*#EXTENSION*/
          
        from dbo.EMAILADDRESS
        left join dbo.EMAILADDRESSTYPECODE on EMAILADDRESSTYPECODE.ID = EMAILADDRESS.EMAILADDRESSTYPECODEID
        left join dbo.INFOSOURCECODE on INFOSOURCECODE.ID = EMAILADDRESS.INFOSOURCECODEID
        left join dbo.CHANGEAGENT as [ADDEDBY] on ADDEDBY.ID = EMAILADDRESS.ADDEDBYID
        left join dbo.CHANGEAGENT as [CHANGEDBY] on CHANGEDBY.ID = EMAILADDRESS.CHANGEDBYID

        where EMAILADDRESS.ISPRIMARY=1
      
      ]]>
    </ViewSQL>
  </ViewImplementation>
  <Output>
    <OutputFields>
      <OutputField Caption="System record ID" Category="System Fields" Name="ID" CaptionResourceKey="$$system_record_id" CategoryResourceKey="$$system_fields" />
      <OutputField Caption="Constituent ID" IsHidden="true" Name="CONSTITUENTID" CaptionResourceKey="$$constituent_id" />
      <OutputField Caption="Email address type" Name="EMAILADDRESSTYPECODEID_TRANSLATION" CaptionResourceKey="$$email_address_type">
        <LookupInfo IDField="EMAILADDRESSTYPECODEID">
          <CodeTable CodeTableName="EMAILADDRESSTYPECODE" IncludeInactive="true" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Email address" Name="EMAILADDRESS" CaptionResourceKey="$$email_address" />
      <OutputField Caption="Do not email" Name="DONOTEMAIL" CaptionResourceKey="$$do_not_email" />
      <OutputField Caption="Added by application" Category="System Fields" Name="ADDEDBY_APPLICATION" CaptionResourceKey="$$added_by_application" CategoryResourceKey="$$system_fields">
        <LookupInfo>
          <SimpleDataList SimpleDataListID="37E3E458-AF0D-4dbc-8A18-A93885521A42" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Added by user name" Category="System Fields" Name="ADDEDBY_USERNAME" CaptionResourceKey="$$added_by_user_name" CategoryResourceKey="$$system_fields">
        <LookupInfo>
          <SimpleDataList SimpleDataListID="CEA15E1C-E455-41be-9ECF-6B5453FA96A4" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Changed by application" Category="System Fields" Name="CHANGEDBY_APPLICATION" CaptionResourceKey="$$changed_by_application" CategoryResourceKey="$$system_fields">
        <LookupInfo>
          <SimpleDataList SimpleDataListID="37E3E458-AF0D-4dbc-8A18-A93885521A42" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Changed by user name" Category="System Fields" Name="CHANGEDBY_USERNAME" CaptionResourceKey="$$changed_by_user_name" CategoryResourceKey="$$system_fields">
        <LookupInfo>
          <SimpleDataList SimpleDataListID="CEA15E1C-E455-41be-9ECF-6B5453FA96A4" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Date added" Category="System Fields" Name="DATEADDED" CaptionResourceKey="$$date_added" CategoryResourceKey="$$system_fields" />
      <OutputField Caption="Date changed" Category="System Fields" Name="DATECHANGED" CaptionResourceKey="$$date_changed" CategoryResourceKey="$$system_fields" />
      <OutputField Caption="Timestamp value" Category="System Fields" IsHidden="true" Name="TSLONG" CaptionResourceKey="$$timestamp_value" CategoryResourceKey="$$system_fields" />
      <OutputField Name="INFOSOURCECODEID_TRANSLATION" Caption="Information source" CaptionResourceKey="$$information_source">
        <LookupInfo IDField="INFOSOURCECODEID">
          <CodeTable CodeTableName="INFOSOURCECODE" IncludeInactive="true" />
        </LookupInfo>
      </OutputField>
      <OutputField Name="INFOSOURCECOMMENTS" Caption="Information source comments" CaptionResourceKey="$$information_source_comments" />
      <OutputField Name="ORIGIN" Caption="Origin" DataType="String" CaptionResourceKey="$$origin">
        <LookupInfo>
          <TranslationList>
            <c:Options>
              <c:TranslationListOption Value="User" />
              <c:TranslationListOption Value="Web Forms" />
            </c:Options>
          </TranslationList>
        </LookupInfo>
      </OutputField>
      <OutputField Name="ORIGININFO" Caption="Origin information" DataType="String" CaptionResourceKey="$$origin_information" />
      <OutputField Name="RELATIONSHIPID" Caption="Relationship ID" IsHidden="true" CaptionResourceKey="$$relationship_id" />
      <OutputField Name="STARTDATE" Caption="Start date" CaptionResourceKey="$$start_date" />
      <OutputField Name="ENDDATE" Caption="End date" CaptionResourceKey="$$end_date" />
      <OutputField Name="BOUNCED" Caption="Bounced" DataType="Boolean" CaptionResourceKey="$$bounced" />
      <OutputField Name="EMAILADDRESSTYPECODEID" Caption="Email address type code ID" DataType="Guid" IsHidden="true" CaptionResourceKey="$$email_address_type_code_id" />
      <OutputField Name="INFOSOURCECODEID" Caption="Info source code ID" DataType="Guid" IsHidden="true" CaptionResourceKey="$$info_source_code_id" />
      <OutputField Name="SPAMCOMPLAINT" Caption="Spam complaint" DataType="Boolean" CaptionResourceKey="$$spam_complaint" />
    </OutputFields>
    <IdentifyingFields>
      <IdentifyingField Name="EMAILADDRESS" />
    </IdentifyingFields>
  </Output>
  <RelationshipOperations>
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_CONSTITUENT" ParentViewRelatedField="ID" PathAlias="Email Address (Primary) (AIA)" />
    <AddToParentView Field="RELATIONSHIPID" ParentView="V_QUERY_RELATIONSHIPS" ParentViewRelatedField="ID" PathAlias="Email Address (Primary) (AIA)" />
    <AddRelatedView RelatedView="V_QUERY_RELATIONSHIPS" RelatedField="ID" Field="RELATIONSHIPID" PathAlias="Relationship" DisplayAliasResourceKey="$$relationship" />
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_RECORD" ParentViewRelatedField="ID" PathAlias="Email Address (Primary) (AIA)" />
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_ORGANIZATION" ParentViewRelatedField="ID" PathAlias="Email Address (Primary) (AIA)" />
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_STUDENT" ParentViewRelatedField="ID" PathAlias="Email Address (Primary) (AIA)" />
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_FACULTY" ParentViewRelatedField="ID" PathAlias="Email Address (Primary) (AIA)" />
  </RelationshipOperations>
</QueryViewSpec>

