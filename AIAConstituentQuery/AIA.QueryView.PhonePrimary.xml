<QueryViewSpec
  xmlns="bb_appfx_queryview"
  xmlns:c="bb_appfx_commontypes" 
  ID="89f4fc37-7202-4c67-9d33-f78843d31678"
  Name="Phone (Primary) (AIA)"
  Description="This provides the ability to query for primary phone information."
  Author="Danny Smith (AIA)"
  IsRoot="false"
  PrimaryKeyField="ID"
  RecordType="Email"
  c:SecurityUIFolder="Constituent\Phones"
  >
  <Extensibility>
    <Tables>
      <Table Name="PHONE" />
    </Tables>
  </Extensibility>
  <ResourceFile AssemblyName="Blackbaud.AppFx.Constituent.Catalog.dll" ClassName="Blackbaud.AppFx.Constituent.Catalog.Phone.Query" />

  <!-- define the view used to return data for the query -->
  <ViewImplementation ViewName="USR_AIA_V_QUERY_CONSTITUENTPRIMARYPHONE">
    <ViewSQL>
      <![CDATA[

        select
          PHONE.ID,
          PHONE.CONSTITUENTID,
          PHONETYPECODE.DESCRIPTION as [PHONETYPECODEID_TRANSLATION],
          PHONE.NUMBER,
          --PHONE.ISPRIMARY,
          PHONE.DONOTCALL,
          [ADDEDBY].APPLICATIONNAME as [ADDEDBY_APPLICATION],
          [ADDEDBY].USERNAME as [ADDEDBY_USERNAME],
          [CHANGEDBY].APPLICATIONNAME as [CHANGEDBY_APPLICATION],
          [CHANGEDBY].USERNAME as [CHANGEDBY_USERNAME],
          PHONE.DATEADDED,
          PHONE.DATECHANGED,
          PHONE.TSLONG,
          PHONE.STARTTIME,
          PHONE.ENDTIME,
          INFOSOURCECODE.DESCRIPTION as [INFOSOURCECODEID_TRANSLATION],
          PHONE.INFOSOURCECOMMENTS,
          dbo.UFN_COUNTRY_GETDESCRIPTION(PHONE.COUNTRYID) as COUNTRY,
          PHONE.STARTDATE,
          PHONE.ENDDATE,
          DONOTCALLREASONCODE.DESCRIPTION as [DONOTCALLREASONCODEID_TRANSLATION],
          PHONE.ISCONFIDENTIAL,
          dbo.UFN_PHONE_GETINTERNATIONALNUMBER(PHONE.COUNTRYID, PHONE.NUMBER) as INTERNATIONALNUMBER,
          PHONE.RELATIONSHIPID,
          PHONE.ORIGIN,
          case 
            when [ORIGINCODE] <> 0 then 
              dbo.UFN_PHONE_ORIGINCODE_GETDESCRIPTION([ORIGINCODE]) 
            else INFOSOURCECODE.DESCRIPTION 
          end as [ORIGININFO],
          PHONE.SEASONALSTARTDATE,
          PHONE.SEASONALENDDATE,
          [PHONE].[PHONETYPECODEID],
          [PHONE].[INFOSOURCECODEID],
          [PHONE].[DONOTCALLREASONCODEID],
          [PHONE].[COUNTRYID]
          /*#EXTENSION*/
          
        from dbo.PHONE
        left join dbo.PHONETYPECODE on PHONETYPECODE.ID = PHONE.PHONETYPECODEID
        left join dbo.INFOSOURCECODE on INFOSOURCECODE.ID = PHONE.INFOSOURCECODEID
        left join dbo.DONOTCALLREASONCODE on DONOTCALLREASONCODE.ID = PHONE.DONOTCALLREASONCODEID
        left join dbo.CHANGEAGENT as [ADDEDBY] on ADDEDBY.ID = PHONE.ADDEDBYID
        left join dbo.CHANGEAGENT as [CHANGEDBY] on CHANGEDBY.ID = PHONE.CHANGEDBYID

        where PHONE.ISPRIMARY=1

      ]]>
    </ViewSQL>
  </ViewImplementation>
  <Output>
    <OutputFields>
      <OutputField Caption="System record ID" Category="System Fields" Name="ID" CaptionResourceKey="$$system_record_id" CategoryResourceKey="$$system_fields" />
      <OutputField Caption="Constituent ID" IsHidden="true" Name="CONSTITUENTID" CaptionResourceKey="$$constituent_id" />
      <OutputField Caption="Phone type" Name="PHONETYPECODEID_TRANSLATION" CaptionResourceKey="$$phone_type">
        <LookupInfo IDField="PHONETYPECODEID">
          <CodeTable CodeTableName="PHONETYPECODE" IncludeInactive="true" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Number" Name="NUMBER" CaptionResourceKey="$$number" />
      <OutputField Caption="Do not call" Name="DONOTCALL" CaptionResourceKey="$$do_not_call" />
      <OutputField Caption="Added by application" Category="System Fields" Name="ADDEDBY_APPLICATION" CaptionResourceKey="$$added_by_application" CategoryResourceKey="$$system_fields">
        <LookupInfo>
          <SimpleDataList SimpleDataListID="37E3E458-AF0D-4dbc-8A18-A93885521A42" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Added by user name" Category="System Fields" Name="ADDEDBY_USERNAME" CaptionResourceKey="$$added_by_user_name" CategoryResourceKey="$$system_fields">
        <LookupInfo>
          <SimpleDataList SimpleDataListID="CEA15E1C-E455-41be-9ECF-6B5453FA96A4" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Changed by application" Category="System Fields" Name="CHANGEDBY_APPLICATION" CaptionResourceKey="$$changed_by_application" CategoryResourceKey="$$system_fields">
        <LookupInfo>
          <SimpleDataList SimpleDataListID="37E3E458-AF0D-4dbc-8A18-A93885521A42" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Changed by user name" Category="System Fields" Name="CHANGEDBY_USERNAME" CaptionResourceKey="$$changed_by_user_name" CategoryResourceKey="$$system_fields">
        <LookupInfo>
          <SimpleDataList SimpleDataListID="CEA15E1C-E455-41be-9ECF-6B5453FA96A4" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Date added" Category="System Fields" Name="DATEADDED" CaptionResourceKey="$$date_added" CategoryResourceKey="$$system_fields" />
      <OutputField Caption="Date changed" Category="System Fields" Name="DATECHANGED" CaptionResourceKey="$$date_changed" CategoryResourceKey="$$system_fields" />
      <OutputField Caption="Timestamp value" Category="System Fields" IsHidden="true" Name="TSLONG" CaptionResourceKey="$$timestamp_value" CategoryResourceKey="$$system_fields" />
      <OutputField Caption="Call after" Name="STARTTIME" CaptionResourceKey="$$call_after" />
      <OutputField Caption="Call before" Name="ENDTIME" CaptionResourceKey="$$call_before" />
      <OutputField Name="INFOSOURCECODEID_TRANSLATION" Caption="Information source" CaptionResourceKey="$$information_source">
        <LookupInfo IDField="INFOSOURCECODEID">
          <CodeTable CodeTableName="INFOSOURCECODE" IncludeInactive="true" />
        </LookupInfo>
      </OutputField>
      <OutputField Name="INFOSOURCECOMMENTS" Caption="Information source comments" CaptionResourceKey="$$information_source_comments" />
      <OutputField Name="ORIGIN" Caption="Origin" DataType="String" CaptionResourceKey="$$origin">
        <LookupInfo>
          <TranslationList>
            <c:Options>
              <c:TranslationListOption Value="User" />
              <c:TranslationListOption Value="Web Forms" />
            </c:Options>
          </TranslationList>
        </LookupInfo>
      </OutputField>
      <OutputField Name="ORIGININFO" Caption="Origin information" DataType="String" CaptionResourceKey="$$origin_information" />
      <OutputField Name="COUNTRY" Caption="Country" CaptionResourceKey="$$country">
        <LookupInfo IDField="COUNTRYID">
          <SimpleDataList SimpleDataListID="C9649672-353D-42E8-8C25-4D34BBABFBBA" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Start date" Name="STARTDATE" CaptionResourceKey="$$start_date" />
      <OutputField Caption="End date" Name="ENDDATE" CaptionResourceKey="$$end_date" />
      <OutputField Name="DONOTCALLREASONCODEID_TRANSLATION" Caption="Do not call reason" CaptionResourceKey="$$do_not_call_reason">
        <LookupInfo IDField="DONOTCALLREASONCODEID">
          <CodeTable CodeTableName="DONOTCALLREASONCODE" IncludeInactive="true" />
        </LookupInfo>
      </OutputField>
      <OutputField Caption="Confidential" Name="ISCONFIDENTIAL" CaptionResourceKey="$$confidential" />
      <OutputField Caption="International number" Name="INTERNATIONALNUMBER" CaptionResourceKey="$$international_number" />
      <OutputField Name="RELATIONSHIPID" Caption="Relationship ID" IsHidden="true" CaptionResourceKey="$$relationship_id" />
      <OutputField Name="SEASONALSTARTDATE" Caption="Seasonal start date" CaptionResourceKey="$$seasonal_start_date" />
      <OutputField Name="SEASONALENDDATE" Caption="Seasonal end date" CaptionResourceKey="$$seasonal_end_date" />
      <OutputField Name="PHONETYPECODEID" Caption="Phone type code ID" DataType="Guid" IsHidden="true" CaptionResourceKey="$$phone_type_code_id" />
      <OutputField Name="INFOSOURCECODEID" Caption="Info source code ID" DataType="Guid" IsHidden="true" CaptionResourceKey="$$info_source_code_id" />
      <OutputField Name="DONOTCALLREASONCODEID" Caption="Do not call reason code ID" DataType="Guid" IsHidden="true" CaptionResourceKey="$$do_not_call_reason_code_id" />
      <OutputField Name="COUNTRYID" Caption="Country ID" DataType="Guid" IsHidden="true" CaptionResourceKey="$$country_id" />
    </OutputFields>
    <IdentifyingFields>
      <IdentifyingField Name="NUMBER" />
    </IdentifyingFields>
  </Output>
  <RelationshipOperations>
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_CONSTITUENT" ParentViewRelatedField="ID" PathAlias="Phone (Primary) (AIA)" />
    <AddToParentView Field="RELATIONSHIPID" ParentView="V_QUERY_RELATIONSHIPS" ParentViewRelatedField="ID" PathAlias="Phone (Primary) (AIA)" />
    <AddRelatedView RelatedView="V_QUERY_RELATIONSHIPS" RelatedField="ID" Field="RELATIONSHIPID" PathAlias="Relationship" DisplayAliasResourceKey="$$relationship" />
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_RECORD" ParentViewRelatedField="ID" PathAlias="Phone (Primary) (AIA)" />
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_ORGANIZATION" ParentViewRelatedField="ID" PathAlias="Phone (Primary) (AIA)" />
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_STUDENT" ParentViewRelatedField="ID" PathAlias="Phone (Primary) (AIA)" />
    <AddToParentView Field="CONSTITUENTID" ParentView="V_QUERY_FACULTY" ParentViewRelatedField="ID" PathAlias="Phone (Primary) (AIA)" />
  </RelationshipOperations>
</QueryViewSpec>

